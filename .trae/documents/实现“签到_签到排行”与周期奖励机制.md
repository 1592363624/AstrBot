## 目标与范围

* 新增命令：`签到`、`签到排行`；入口仅注册，业务逻辑独立处理器。

* 奖励体系：基础每日递增 + 7天周期主题奖励 + 里程碑奖励；签到成功后按概率触发随机事件。

* 排行：支持连续天数、累计次数、近窗排行；修真风格文案输出。

* 配置：全部写入并读取自 `system_config` 表（前缀 `signin.*`），后台用现有 `admin/api/system_config.py` 进行编辑。

* 数据库：新增签到日志与里程碑表，自动迁移，保持 WAL 模式一致性。

## 配置项（全部存入 system\_config）

* `signin.enabled`(bool) 是否启用

* `signin.base_reward_start`(int) 基础奖励起点

* `signin.base_reward_increment`(int) 每日递增步长

* `signin.base_reward_cap`(int) 基础奖励上限（可选）

* `signin.cycle_length`(int) 周期长度，默认 7

* `signin.cycle_theme_rewards`(json) `{"1":[...],...,"7":[...]}` 每日主题奖励效果列表（gold/xp/item）

* `signin.milestone_thresholds`(json array) 如 `[{"days":7, "rewards":[...]}]`

* `signin.random_event_probability`(float) 0–1

* `signin.random_event_tag`(string) 事件标识（如 `command:签到`）

* `signin.leaderboard_metric`(string) `streak`|`total`|`recent`

* `signin.leaderboard_window_days`(int) `recent` 用窗口天数

* `signin.top_n`(int) 排行展示人数

* `signin.reward_units`(string) 文案单位（如 `灵石`）

* 默认值通过迁移脚本 `INSERT OR IGNORE` 写入 `system_config`，后台可 CRUD 更新。

## 数据库与迁移

* 表 `sign_in_logs`：`id(PK)`, `user_id`, `sign_date(DATE)`, `streak_count(INT)`, `cycle_day(INT)`, `rewards_json(TEXT)`, `event_tag(TEXT)`, `created_at(TIMESTAMP)`；索引 `idx_sign_in_logs_user_date`, `idx_sign_in_logs_date`。

* 表 `sign_in_milestones`：`id(PK)`, `user_id`, `milestone(INT)`, `awarded_at(TIMESTAMP)`；`UNIQUE(user_id, milestone)`，索引 `idx_sign_in_milestones_user`。

* 在 `core/database/migrations.py` 增量注册迁移，写入 external comments；启动自动应用；保持 `journal_mode=WAL` 与 `foreign_keys=ON`。

## 命令与处理器

* `main.py`：注册 `签到`、`签到排行`，委托 `core/handlers/signin_handlers.py`。

* 新增 `core/handlers/signin_handlers.py`：

  * `handle_sign_in(ctx) -> str`：检查当日重复→计算连续天数与周期日→三重奖励→随机事件→入库→修真文案。

  * `handle_signin_leaderboard(ctx) -> str`：读取排行配置→计算并生成文案。

  * 统一读取 `system_config`，无硬编码；调用现有增减接口 `core/api/game.py::adjust_value`、`core/api/inventory.py::adjust_item_quantity`、`core/api/player.py`。

## 奖励计算

* 基础：`base = min(base_start + streak * base_increment, base_cap)`（无上限则不约束）。

* 周期：`cycle_day = ((streak - 1) % cycle_length) + 1`，执行 `cycle_theme_rewards[cycle_day]` 效果列表。

* 里程碑：阈值达成且未发放则发放并记录到 `sign_in_milestones`。

## 随机事件

* 签到成功后调用 `EventEngine.handle_trigger("command", {"name": "签到", "user_id": ..., "tag": signin.random_event_tag, ...})`；后台事件配置加 `command=name=签到` + `probability` 条件。

## 排行逻辑

* `streak`：用户最新连续天数排序。

* `total`：累计签到次数排序（`COUNT(*)`）。

* `recent`：近 `leaderboard_window_days` 内签到次数排序。

* 文案：修真风格，突出【道号/用户ID】【连续天数/次数】【奖励单位】。

## 后台与前端

* 后端新增 `admin/api/signin.py`：

  * `GET /api/signin/leaderboard`：参数 `metric`、`window_days`、`top_n`。

  * `GET /api/signin/stats/{user_id}`：返回连续/总/近窗统计。

* 前端 `admin/frontend/index.html`：

  * 在配置面板接入 `system_config` 的 `signin.*` 键编辑；

  * 新增排行查看入口（当前用户已打开该文件，面板将增量插入）。

## 验证

* 手工：首次签到、当日重复、跨周周期奖励、里程碑发放、排行展示。

* 后台：`system_config` 对 `signin.*` 键的 CRUD 生效；`/api/signin/leaderboard` 数据与配置一致。

## 规范

* Python 3.10、PEP8；所有 import 顶部；方法、字段、属性及模块内小逻辑均含中文注释；不使用 requests。

## 预计改动列表

* 新增：`core/handlers/signin_handlers.py`、`admin/api/signin.py`

* 修改：`main.py`（增量命令注册）、`core/database/migrations.py`（新增两表与默认配置写入）、`admin/frontend/index.html`（增量面板与入口）、`README.md`（指令与配置说明）。

## 提交摘要（计划）

* 计划新增：签到处理器、数据库与迁移、`system_config` 配置键、后台 API、前端入口、命令注册、文档。

* 计划修改：`main.py`、`migrations.py`、`index.html`、`README.md`。

